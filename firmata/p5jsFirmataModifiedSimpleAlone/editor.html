<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- Origin Trial Token, feature = WebUSB (For Chrome M57+), origin = https://deqingsun.github.io, expires = 2017-05-25 -->
    <meta http-equiv="origin-trial" data-feature="WebUSB (For Chrome M57+)" data-expires="2017-05-25" content="ApHX3h8gWStZyrBGdXU2s/V846EF3bLGt5o0HNZT3eAHr2l3ESW3X91c1iFOMfZjExl73xJL/W6AdemCApQbtQ4AAABUeyJvcmlnaW4iOiJodHRwczovL2RlcWluZ3N1bi5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYlVTQjIiLCJleHBpcnkiOjE0OTU3MzYzMDd9">
    <title>P5JS insert</title>
</head>

<body>


    <textarea id="code" style="height: 400px; width: 600px;"></textarea>
    <button onclick="runCode()" id="runButton">Run code</button>
    <div id="iframeContainer">
        <iframe id="testFrame" style="height: 400px; width: 600px;">
            <p>Your browser does not support iframes.</p>
        </iframe>
    </div>

    <script>
        function runCode() {
            var metas = document.getElementsByTagName('meta');
            var metaStr = '<meta charset="utf-8">\n';
            var test;
            for (var i = 0; i < metas.length; i++) {
                if (metas[i].httpEquiv == 'origin-trial') {
                    metaStr = metaStr + '<meta http-equiv="origin-trial" data-feature="' + metas[i].dataset.feature + '" data-expires="' + metas[i].dataset.expires + '" content="' + metas[i].content + '">';
                }
            }

            var html = '';
            var css = '';
            var js = document.getElementById('code').value;

            var p5lib = '<script src="libraries\/p5.min.js" type="text\/javascript"><\/script>'
            var webusbFirmataLib = '<script src="libraries\/p5.webusbFirmata.js" type="text\/javascript"><\/script>'

            var result = '<html><head>' + metaStr + p5lib + webusbFirmataLib + '<style>' + css + '</style></head><body>' + html + '<script type="text/javascript">' + js + '<\/script><\/body><\/html>';

            var iframe = document.getElementById('testFrame');
            iframe.style.display = 'none';
            
            var existIframe = document.getElementById('testFrameDup');
            if (existIframe) document.getElementById('iframeContainer').removeChild(existIframe);

            var iframeDup = iframe.cloneNode(true);
            iframeDup.style.display = 'block';
            iframeDup.id="testFrameDup"
            document.getElementById('iframeContainer').appendChild(iframeDup);

            if (iframeDup.contentDocument) doc = iframeDup.contentDocument;
            else if (iframeDup.contentWindow) doc = iframeDup.contentWindow.document;
            else doc = iframeDup.document;


            doc.open();
            doc.writeln(result);
            doc.close();
        }


        var client = new XMLHttpRequest();
        client.open('GET', 'sketch.js');
        client.onreadystatechange = function () {
            document.getElementById('code').value = client.responseText;
        }
        client.send();
    </script>
</body>

</html>