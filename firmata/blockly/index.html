<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- Origin Trial Token, feature = WebUSB, origin = https://deqingsun.github.io, expires = 2017-01-24 -->
    <meta http-equiv="origin-trial" data-feature="WebUSB" data-expires="2017-01-24" content="AiH6LEOeWweanSHGKeSsBYXiI9otHAUhTXbzVcTZi0vbmzFN1H8A6Rr+TJ/tmFS2nmO++zbfQUJzx14klOJ6TQoAAABTeyJvcmlnaW4iOiJodHRwczovL2RlcWluZ3N1bi5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYlVTQiIsImV4cGlyeSI6MTQ4NTI3NDAyMH0=">
    <title>Blockly Demo: Generating JavaScript</title>
    <script src="./blockly_compressed.js"></script>
    <script src="./blocks_compressed.js"></script>
    <script src="./javascript_compressed.js"></script>
    <script src="./msg/js/en.js"></script>
    <script src="acorn_interpreter.js"></script>

    <script src="serial.js"></script>
    <script src="modifiedFirmata.js"></script>
    <script src="main.js"></script>
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }
        
        h1 {
            font-weight: normal;
            font-size: 140%;
        }
    </style>
</head>

<body>

    <p>This is a simple demo of generating code from blocks.</p>

    <p>
        <button onclick="connectWebUSB()" id="connect">Connect</button>
    </p>

    <p>
        <button onclick="parseCode()">Parse JavaScript</button>
        <button onclick="stepCode()" id="stepButton" disabled="disabled">Step JavaScript</button>
        <button onclick="runCode()">Run JavaScript</button>
        <button onclick="stopCode()">Stop JavaScript</button>
    </p>

    <div id="blocklyDiv" style="height: 600px; width: 800px;"></div>

    <xml id="toolbox" style="display: none">
        <category name="Logic">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="Loops">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
        </category>
        <category name="Text">
            <block type="text"></block>
            <block type="text_length"></block>
            <block type="text_print"></block>
        </category>
        <category name="Variables" custom="VARIABLE"></category>
        <category name="Funkey Firmata">
            <block type="readdigital"></block>
            <block type="writedigital"></block>
            <block type="delay"></block>
        </category>
    </xml>
    <!-- var xml = Blockly.Xml.workspaceToDom(workspace);var xml_text = Blockly.Xml.domToPrettyText(xml);console.log(xml_text); -->
    <xml id="startBlocks" style="display: none">
        <block type="controls_repeat_ext">
            <value name="TIMES">
                <block type="math_number">
                    <field name="NUM">999</field>
                </block>
            </value>
            <statement name="DO">
                <block type="delay">
                    <value name="millis">
                        <block type="math_number">
                            <field name="NUM">10</field>
                        </block>
                    </value>
                    <next>
                        <block type="controls_if">
                            <mutation else="1"></mutation>
                            <value name="IF0">
                                <block type="logic_compare">
                                    <field name="OP">EQ</field>
                                    <value name="A">
                                        <block type="readdigital">
                                            <value name="CHANNEL">
                                                <block type="math_number">
                                                    <field name="NUM">7</field>
                                                </block>
                                            </value>
                                        </block>
                                    </value>
                                    <value name="B">
                                        <block type="logic_boolean">
                                            <field name="BOOL">TRUE</field>
                                        </block>
                                    </value>
                                </block>
                            </value>
                            <statement name="DO0">
                                <block type="writedigital">
                                    <value name="CHANNEL">
                                        <block type="math_number">
                                            <field name="NUM">10</field>
                                        </block>
                                    </value>
                                    <value name="VALUE">
                                        <block type="logic_boolean">
                                            <field name="BOOL">TRUE</field>
                                        </block>
                                    </value>
                                </block>
                            </statement>
                            <statement name="ELSE">
                                <block type="writedigital">
                                    <value name="CHANNEL">
                                        <block type="math_number">
                                            <field name="NUM">10</field>
                                        </block>
                                    </value>
                                    <value name="VALUE">
                                        <block type="logic_boolean">
                                            <field name="BOOL">FALSE</field>
                                        </block>
                                    </value>
                                </block>
                            </statement>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
    </xml>
    <div id="buffer"></div>

    <script>
        Blockly.Blocks['readdigital'] = {
            init: function () {
                this.appendValueInput("CHANNEL")
                    .setCheck("Number")
                    .appendField("Digital Read Channel");
                this.setOutput(true, null);
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.Blocks['writedigital'] = {
            init: function () {
                this.appendValueInput("CHANNEL")
                    .setCheck("Number")
                    .appendField("Digital Write Channel");
                this.appendValueInput("VALUE")
                    .setCheck("Boolean")
                    .setAlign(Blockly.ALIGN_RIGHT)
                    .appendField("Level");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.Blocks['delay'] = {
            init: function () {
                this.appendValueInput("millis")
                    .setCheck("Number")
                    .appendField("delayMillis");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };

        Blockly.JavaScript['readdigital'] = function (block) {
            var value_channel = Blockly.JavaScript.valueToCode(block, 'CHANNEL', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'modifiedFirmata_simpleReadDigital(' + value_channel + ')';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };

        Blockly.JavaScript['writedigital'] = function (block) {
            var value_channel = Blockly.JavaScript.valueToCode(block, 'CHANNEL', Blockly.JavaScript.ORDER_ATOMIC);
            var value_value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'modifiedFirmata_simpleWriteDigital(' + value_channel + ',' + value_value + ');';
            return code;
        };

        Blockly.JavaScript['delay'] = function (block) {
            var value_millis = Blockly.JavaScript.valueToCode(block, 'millis', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'blocklyDelay(' + value_millis + ');';
            return code;
        };

        var workspace = Blockly.inject('blocklyDiv', {
            media: './media/'
            , toolbox: document.getElementById('toolbox')
        });
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks')
            , workspace);

        var myInterpreter = null;
        var runStepsTimeout = null;
        var runStepsStop = false;

        function initApi(interpreter, scope) {
            // Add an API function for the alert() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(alert(text));
            };
            interpreter.setProperty(scope, 'alert'
                , interpreter.createNativeFunction(wrapper));

            // Add an API function for the prompt() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(prompt(text));
            };
            interpreter.setProperty(scope, 'prompt'
                , interpreter.createNativeFunction(wrapper));

            // Add an API function for highlighting blocks.
            var wrapper = function (id) {
                id = id ? id.toString() : '';
                return interpreter.createPrimitive(highlightBlock(id));
            };
            interpreter.setProperty(scope, 'highlightBlock'
                , interpreter.createNativeFunction(wrapper));

            // Add an API function for the readdigital() block.
            var wrapper = function (channel) {
                channel = channel ? channel.toString() : '';
                return interpreter.createPrimitive(modifiedFirmata.simpleReadDigital(channel));
            };
            interpreter.setProperty(scope, 'modifiedFirmata_simpleReadDigital'
                , interpreter.createNativeFunction(wrapper));
            // Add an API function for the writedigital() block.
            var wrapper = function (channel, value) {
                channel = channel ? channel.toString() : '';
                value = (value && value.data) ? true : false;
                return interpreter.createPrimitive(modifiedFirmata.simpleWriteDigital(channel, value));
            };
            interpreter.setProperty(scope, 'modifiedFirmata_simpleWriteDigital'
                , interpreter.createNativeFunction(wrapper));

            var wrapper = function (millis, callback) {
                millis = millis ? millis.toString() : '';
                var callbackFunc = function () {
                    callback(interpreter.createPrimitive());
                }
                setTimeout(callbackFunc, millis);
            };
            interpreter.setProperty(scope, 'blocklyDelay', interpreter.createAsyncFunction(wrapper));
        }

        var highlightPause = false;

        function highlightBlock(id) {
            workspace.highlightBlock(id);
            highlightPause = true;
        }

        function parseCode() {
            // Generate JavaScript code and parse it.
            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            myInterpreter = new Interpreter(code, initApi);

            alert('Ready to execute this code:\n\n' + code);
            document.getElementById('stepButton').disabled = '';
            highlightPause = false;
            workspace.highlightBlock(null);

            clearTimeout(runStepsTimeout);
        }

        function stepCode() {
            clearTimeout(runStepsTimeout);
            try {
                var ok = myInterpreter.step();
            } finally {
                if (!ok) {
                    // Program complete, no more code to execute.
                    document.getElementById('stepButton').disabled = 'disabled';
                    workspace.highlightBlock(null);
                    return;
                }
            }
            if (highlightPause) {
                // A block has been highlighted.  Pause execution here.
                highlightPause = false;
            } else {
                // Keep executing until a highlight statement is reached.
                stepCode();
            }
        }

        function runCode() {
            // Generate JavaScript code and parse it.
            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            myInterpreter = new Interpreter(code, initApi);

            document.getElementById('stepButton').disabled = '';
            highlightPause = false;
            workspace.highlightBlock(null);
            clearTimeout(runStepsTimeout);
            runStepsTimeout = setTimeout("runSteps()", 0);
            runStepsStop = false;
        }

        function runSteps() {
            clearTimeout(runStepsTimeout);
            try {
                var ok = myInterpreter.step();
            } finally {
                if (!ok) {
                    // Program complete, no more code to execute.
                    document.getElementById('stepButton').disabled = 'disabled';
                    workspace.highlightBlock(null);
                    return;
                }
            }

            if (runStepsStop) {
                // A block has been highlighted.  Pause execution here.
                //highlightPause = false;
            } else {
                // Keep executing until a highlight statement is reached.
                runStepsTimeout = setTimeout("runSteps()", 0);
            }
        }

        function stopCode() {
            clearTimeout(runStepsTimeout);
            runStepsStop = true;
        }
    </script>

</body>

</html>