<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- Origin Trial Token, feature = WebUSB (For Chrome M57+), origin = https://deqingsun.github.io, expires = 2017-09-05 -->
    <meta http-equiv="origin-trial" data-feature="WebUSB (For Chrome M57+)" data-expires="2017-09-05" content="AmLWGTzxckQANrW+FRfQfTjdgyvd9L8QZx0UHeYEhSHwkLS2gHjaNb/hlJNjvZqEW6pTAMo4Datc9ZOPYFgJTwEAAABUeyJvcmlnaW4iOiJodHRwczovL2RlcWluZ3N1bi5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYlVTQjIiLCJleHBpcnkiOjE1MDQ1Njk2MDB9">
    <title>Blockly Demo: Generating JavaScript</title>
    <script src="./blockly_compressed.js"></script>
    <script src="./blocks_compressed.js"></script>
    <script src="./javascript_compressed.js"></script>
    <script src="./msg/js/en.js"></script>
    <script src="acorn_interpreter.js"></script>
    <script src="serial.js"></script>
    <script src="modifiedFirmata.js"></script>
    <script src="main.js"></script>
    <script src="./ace-src-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var editor;
        window.onload = function () {
            editor = ace.edit("editor");
            editor.getSession().setMode("ace/mode/javascript");
            editor.getSession().setTabSize(2);
            editor.getSession().setUseWrapMode(true);
        }
    </script>
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }
        
        h1 {
            font-weight: normal;
            font-size: 140%;
        }
        
        #editor {
            margin-left: 0px;
            margin-top: 0px;
            width: 800px;
            height: 400px;
        }
    </style>
</head>

<body>
    <p>This is a simple demo of generating code from blocks.</p>
    <p>
        <button onclick="connectWebUSB()" id="connect">Connect</button>
    </p>
    <table border="0">
        <tr>
            <td>
                <div id="blocklyDiv" style="height: 600px; width: 800px;"></div>
            </td>
            <td> value display 0:
                <br>
                <input type="text" id="valueDisp0">
                <br> value display 1:
                <br>
                <input type="text" id="valueDisp1">
                <br> value display 2:
                <br>
                <input type="text" id="valueDisp2">
                <br> value display 3:
                <br>
                <input type="text" id="valueDisp3">
                <br> value display 4:
                <br>
                <input type="text" id="valueDisp4">
                <br> value display 5:
                <br>
                <input type="text" id="valueDisp5">
                <br>
            </td>
        </tr>
    </table>
    <p>
        <button onclick="runCodeBlocks()" id="runButtonBlocks">Run Blocks with highlight</button>
        <button onclick="runFullspeedCodeBlocks()" id="runFullSpeedButtonBlocks">Run Blocks Fullspeed</button>
        <button onclick="stopCodeBlocks()" id="stopButtonBlocks" disabled="disabled">Stop Blocks</button>
        <button onclick="saveCodeBlocks()" id="saveButtonBlocks">Save Blocks on Cloud</button>
    </p>
    <p>
        <button onclick="genCode()" id="runButton">Generate JS from Blocks</button>
        <button onclick="runFullspeedCode()" id="runFullSpeedButton">Run JavaScript Fullspeed</button>
        <button onclick="stopCode()" id="stopButton" disabled="disabled">Stop JavaScript</button>
    </p>

    <div id="editor"></div>
    <xml id="toolbox" style="display: none">
        <category name="Logic">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="Loops">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
        </category>
        <category name="Text">
            <block type="text"></block>
            <block type="text_length"></block>
            <block type="text_print"></block>
            <block type="text_log"></block>
            <block type="text_dispValue"></block>
        </category>
        <category name="Variables" custom="VARIABLE"></category>
        <category name="Funkey Firmata">
            <block type="readdigital"></block>
            <block type="readanalog"></block>
            <block type="writedigital"></block>
            <block type="delay"></block>
        </category>
    </xml>
    <!-- var xml = Blockly.Xml.workspaceToDom(workspace);var xml_text = Blockly.Xml.domToPrettyText(xml);console.log(xml_text.replace(/\s+id=".*?"/g, "")); -->
    <!-- regex to match id -->
    <xml id="startBlocks" style="display: none">
        <block type="controls_whileUntil">
            <field name="MODE">WHILE</field>
            <value name="BOOL">
                <block type="logic_boolean">
                    <field name="BOOL">TRUE</field>
                </block>
            </value>
            <statement name="DO">
                <block type="delay">
                    <value name="millis">
                        <block type="math_number">
                            <field name="NUM">10</field>
                        </block>
                    </value>
                    <next>
                        <block type="text_dispValue">
                            <field name="slot">0</field>
                            <value name="Text">
                                <block type="readanalog">
                                    <value name="CHANNEL">
                                        <block type="math_number">
                                            <field name="NUM">0</field>
                                        </block>
                                    </value>
                                </block>
                            </value>
                            <next>
                                <block type="controls_if">
                                    <mutation else="1"></mutation>
                                    <value name="IF0">
                                        <block type="logic_compare">
                                            <field name="OP">GT</field>
                                            <value name="A">
                                                <block type="readanalog">
                                                    <value name="CHANNEL">
                                                        <block type="math_number">
                                                            <field name="NUM">0</field>
                                                        </block>
                                                    </value>
                                                </block>
                                            </value>
                                            <value name="B">
                                                <block type="math_number">
                                                    <field name="NUM">512</field>
                                                </block>
                                            </value>
                                        </block>
                                    </value>
                                    <statement name="DO0">
                                        <block type="writedigital">
                                            <value name="CHANNEL">
                                                <block type="math_number">
                                                    <field name="NUM">0</field>
                                                </block>
                                            </value>
                                            <value name="VALUE">
                                                <block type="logic_boolean">
                                                    <field name="BOOL">TRUE</field>
                                                </block>
                                            </value>
                                        </block>
                                    </statement>
                                    <statement name="ELSE">
                                        <block type="writedigital">
                                            <value name="CHANNEL">
                                                <block type="math_number">
                                                    <field name="NUM">0</field>
                                                </block>
                                            </value>
                                            <value name="VALUE">
                                                <block type="logic_boolean">
                                                    <field name="BOOL">FALSE</field>
                                                </block>
                                            </value>
                                        </block>
                                    </statement>
                                    <next>
                                        <block type="text_dispValue">
                                            <field name="slot">1</field>
                                            <value name="Text">
                                                <block type="readanalog">
                                                    <value name="CHANNEL">
                                                        <block type="math_number">
                                                            <field name="NUM">1</field>
                                                        </block>
                                                    </value>
                                                </block>
                                            </value>
                                            <next>
                                                <block type="controls_if">
                                                    <mutation else="1"></mutation>
                                                    <value name="IF0">
                                                        <block type="logic_compare">
                                                            <field name="OP">GT</field>
                                                            <value name="A">
                                                                <block type="readanalog">
                                                                    <value name="CHANNEL">
                                                                        <block type="math_number">
                                                                            <field name="NUM">1</field>
                                                                        </block>
                                                                    </value>
                                                                </block>
                                                            </value>
                                                            <value name="B">
                                                                <block type="math_number">
                                                                    <field name="NUM">512</field>
                                                                </block>
                                                            </value>
                                                        </block>
                                                    </value>
                                                    <statement name="DO0">
                                                        <block type="writedigital">
                                                            <value name="CHANNEL">
                                                                <block type="math_number">
                                                                    <field name="NUM">1</field>
                                                                </block>
                                                            </value>
                                                            <value name="VALUE">
                                                                <block type="logic_boolean">
                                                                    <field name="BOOL">TRUE</field>
                                                                </block>
                                                            </value>
                                                        </block>
                                                    </statement>
                                                    <statement name="ELSE">
                                                        <block type="writedigital">
                                                            <value name="CHANNEL">
                                                                <block type="math_number">
                                                                    <field name="NUM">1</field>
                                                                </block>
                                                            </value>
                                                            <value name="VALUE">
                                                                <block type="logic_boolean">
                                                                    <field name="BOOL">FALSE</field>
                                                                </block>
                                                            </value>
                                                        </block>
                                                    </statement>
                                                    <next>
                                                        <block type="text_dispValue">
                                                            <field name="slot">2</field>
                                                            <value name="Text">
                                                                <block type="readanalog">
                                                                    <value name="CHANNEL">
                                                                        <block type="math_number">
                                                                            <field name="NUM">2</field>
                                                                        </block>
                                                                    </value>
                                                                </block>
                                                            </value>
                                                            <next>
                                                                <block type="controls_if">
                                                                    <mutation else="1"></mutation>
                                                                    <value name="IF0">
                                                                        <block type="logic_compare">
                                                                            <field name="OP">GT</field>
                                                                            <value name="A">
                                                                                <block type="readanalog">
                                                                                    <value name="CHANNEL">
                                                                                        <block type="math_number">
                                                                                            <field name="NUM">2</field>
                                                                                        </block>
                                                                                    </value>
                                                                                </block>
                                                                            </value>
                                                                            <value name="B">
                                                                                <block type="math_number">
                                                                                    <field name="NUM">512</field>
                                                                                </block>
                                                                            </value>
                                                                        </block>
                                                                    </value>
                                                                    <statement name="DO0">
                                                                        <block type="writedigital">
                                                                            <value name="CHANNEL">
                                                                                <block type="math_number">
                                                                                    <field name="NUM">2</field>
                                                                                </block>
                                                                            </value>
                                                                            <value name="VALUE">
                                                                                <block type="logic_boolean">
                                                                                    <field name="BOOL">TRUE</field>
                                                                                </block>
                                                                            </value>
                                                                        </block>
                                                                    </statement>
                                                                    <statement name="ELSE">
                                                                        <block type="writedigital">
                                                                            <value name="CHANNEL">
                                                                                <block type="math_number">
                                                                                    <field name="NUM">2</field>
                                                                                </block>
                                                                            </value>
                                                                            <value name="VALUE">
                                                                                <block type="logic_boolean">
                                                                                    <field name="BOOL">FALSE</field>
                                                                                </block>
                                                                            </value>
                                                                        </block>
                                                                    </statement>
                                                                </block>
                                                            </next>
                                                        </block>
                                                    </next>
                                                </block>
                                            </next>
                                        </block>
                                    </next>
                                </block>
                            </next>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
    </xml>
    <div id="buffer"></div>
    <script>
        Blockly.Blocks['readdigital'] = {
            init: function () {
                this.appendValueInput("CHANNEL").setCheck("Number").appendField("Digital Read Channel");
                this.setOutput(true, "Boolean");
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };
        Blockly.Blocks['readanalog'] = {
            init: function () {
                this.appendValueInput("CHANNEL").setCheck("Number").appendField("Analog Read Channel");
                this.setOutput(true, "Number");
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };
        Blockly.Blocks['writedigital'] = {
            init: function () {
                this.appendValueInput("CHANNEL").setCheck("Number").appendField("Digital Write Channel");
                this.appendValueInput("VALUE").setCheck("Boolean").setAlign(Blockly.ALIGN_RIGHT).appendField("Level");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };
        Blockly.Blocks['delay'] = {
            init: function () {
                this.appendValueInput("millis").setCheck("Number").appendField("delayMillis");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(65);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };
        Blockly.Blocks['text_log'] = {
            init: function () {
                this.appendValueInput("text").setCheck(null).appendField("log");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip('');
                this.setHelpUrl('http://www.example.com/');
            }
        };
        Blockly.Blocks['text_dispValue'] = {
            init: function () {
                this.appendValueInput("Text").setCheck(null).appendField("display in slot").appendField(new Blockly.FieldDropdown([["0", "0"], ["1", "1"], ["2", "2"], ["3", "3"], ["4", "4"]]), "slot");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip('');
                this.setHelpUrl('');
            }
        };
        Blockly.JavaScript['readdigital'] = function (block) {
            var value_channel = Blockly.JavaScript.valueToCode(block, 'CHANNEL', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'digitalRead(' + value_channel + ')';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
        Blockly.JavaScript['readanalog'] = function (block) {
            var value_channel = Blockly.JavaScript.valueToCode(block, 'CHANNEL', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'analogRead(' + value_channel + ')';
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
        Blockly.JavaScript['writedigital'] = function (block) {
            var value_channel = Blockly.JavaScript.valueToCode(block, 'CHANNEL', Blockly.JavaScript.ORDER_ATOMIC);
            var value_value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'digitalWrite(' + value_channel + ',' + value_value + ');\n';
            return code;
        };
        Blockly.JavaScript['delay'] = function (block) {
            var value_millis = Blockly.JavaScript.valueToCode(block, 'millis', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'blocklyDelay(' + value_millis + ');\n';
            return code;
        };
        Blockly.JavaScript['text_log'] = function (block) {
            var value_text = Blockly.JavaScript.valueToCode(block, 'text', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'log(' + value_text + ');\n';
            return code;
        };
        Blockly.JavaScript['text_dispValue'] = function (block) {
            var dropdown_slot = block.getFieldValue('slot');
            var value_text = Blockly.JavaScript.valueToCode(block, 'Text', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = 'displayInSlot(' + value_text + ',' + dropdown_slot + ');\n';
            return code;
        };
        var workspace = Blockly.inject('blocklyDiv', {
            media: './media/'
            , toolbox: document.getElementById('toolbox')
        });
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
        // An href with #key trigers an AJAX call to retrieve saved blocks.
        if ('BlocklyStorage' in window && window.location.hash.length > 1) {
            BlocklyStorage.retrieveXml(window.location.hash.substring(1));
        }

        var myInterpreter = null;
        var runStepsTimeout = null;
        var runStepsStop = false;

        function initApi(interpreter, scope) {
            // Add an API function for the alert() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(alert(text));
            };
            interpreter.setProperty(scope, 'alert', interpreter.createNativeFunction(wrapper));
            // Add an API function for the log() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(log(text));
            };
            interpreter.setProperty(scope, 'log', interpreter.createNativeFunction(wrapper));
            // Add an API function for the diplay() block.
            var wrapper = function (text, slot) {
                text = text ? text.toString() : '';
                slot = slot ? slot.toString() : '';
                return interpreter.createPrimitive(document.getElementById('valueDisp' + slot).value = text);
            };
            interpreter.setProperty(scope, 'displayInSlot', interpreter.createNativeFunction(wrapper));
            // Add an API function for the prompt() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(prompt(text));
            };
            interpreter.setProperty(scope, 'prompt', interpreter.createNativeFunction(wrapper));
            // Add an API function for highlighting blocks.
            var wrapper = function (id) {
                id = id ? id.toString() : '';
                return interpreter.createPrimitive(highlightBlock(id));
            };
            interpreter.setProperty(scope, 'highlightBlock', interpreter.createNativeFunction(wrapper));
            // Add an API function for the readdigital() block.
            var wrapper = function (channel) {
                channel = channel ? channel.toString() : '';
                return interpreter.createPrimitive(modifiedFirmata.simpleReadDigital(channel));
            };
            interpreter.setProperty(scope, 'digitalRead', interpreter.createNativeFunction(wrapper));
            // Add an API function for the readanalog() block.
            var wrapper = function (channel) {
                channel = channel ? channel.toString() : '';
                return interpreter.createPrimitive(modifiedFirmata.simpleReadAnalog(channel));
            };
            interpreter.setProperty(scope, 'analogRead', interpreter.createNativeFunction(wrapper));
            // Add an API function for the writedigital() block.
            var wrapper = function (channel, value) {
                channel = channel ? channel.toString() : '';
                value = (value && value.data) ? true : false;
                return interpreter.createPrimitive(modifiedFirmata.simpleWriteDigital(channel, value));
            };
            interpreter.setProperty(scope, 'digitalWrite', interpreter.createNativeFunction(wrapper));
            var wrapper = function (millis, callback) {
                millis = millis ? millis.toString() : '';
                var callbackFunc = function () {
                    callback(interpreter.createPrimitive());
                }
                setTimeout(callbackFunc, millis);
            };
            interpreter.setProperty(scope, 'blocklyDelay', interpreter.createAsyncFunction(wrapper));
        }
        var highlightPause = false;

        function highlightBlock(id) {
            workspace.highlightBlock(id);
            highlightPause = true;
        }

        function runCodeBlocks() {
            // Generate JavaScript code and parse it.
            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            myInterpreter = new Interpreter(code, initApi);
            document.getElementById('stopButtonBlocks').disabled = '';
            document.getElementById('runButtonBlocks').disabled = 'disabled';
            document.getElementById('runFullSpeedButtonBlocks').disabled = 'disabled';
            highlightPause = false;
            workspace.highlightBlock(null);
            clearTimeout(runStepsTimeout);
            runStepsTimeout = setTimeout("runSteps()", 0);
            runStepsStop = false;
        }

        function runStepsBlocks() {
            clearTimeout(runStepsTimeout);
            try {
                var ok = myInterpreter.step();
            } finally {
                if (!ok) {
                    // Program complete, no more code to execute.
                    document.getElementById('stopButtonBlocks').disabled = 'disabled';
                    document.getElementById('runButtonBlocks').disabled = '';
                    document.getElementById('runFullSpeedButtonBlocks').disabled = '';
                    workspace.highlightBlock(null);
                    return;
                }
            }
            if (runStepsStop) {
                // A block has been highlighted.  Pause execution here.
                //highlightPause = false;
            } else {
                // Keep executing until a highlight statement is reached.
                runStepsTimeout = setTimeout("runStepsBlocks()", 0);
            }
        }

        function stopCodeBlocks() {
            clearTimeout(runStepsTimeout);
            if (!runStepsStop) runStepsStop = true;
            workspace.highlightBlock(null);
            document.getElementById('stopButtonBlocks').disabled = 'disabled';
            document.getElementById('runButtonBlocks').disabled = '';
            document.getElementById('runFullSpeedButtonBlocks').disabled = '';
        }

        function runFullspeedCodeBlocks() {
            runStepsStop = false;
            document.getElementById('stopButtonBlocks').disabled = '';
            document.getElementById('runButtonBlocks').disabled = 'disabled';
            document.getElementById('runFullSpeedButtonBlocks').disabled = 'disabled';
            // Generate JavaScript code and parse it.
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            myInterpreter = new Interpreter(code, initApi);
            tryToStart();
            //console.log(myInterpreter.run());
        }

        function saveCodeBlocks() {
            BlocklyStorage.link();
        }

        function genCode() {
            Blockly.JavaScript.STATEMENT_PREFIX = '';
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            editor.setValue(code);
        }

        function stopCode() {
            clearTimeout(runStepsTimeout);
            if (!runStepsStop) runStepsStop = true;
            document.getElementById('stopButton').disabled = 'disabled';
            document.getElementById('runButton').disabled = '';
            document.getElementById('runFullSpeedButton').disabled = '';
        }

        function runFullspeedCode() {
            runStepsStop = false;
            document.getElementById('stopButton').disabled = '';
            document.getElementById('runButton').disabled = 'disabled';
            document.getElementById('runFullSpeedButton').disabled = 'disabled';
            var code = editor.getValue();
            myInterpreter = new Interpreter(code, initApi);
            tryToStart();
            //console.log(myInterpreter.run());
        }

        function tryToStart() {
            var thereAreStillCodeLeftToRun = myInterpreter.run();
            if (thereAreStillCodeLeftToRun) {
                if (!runStepsStop) {
                    // Ran until an async call.  Give this call a chance to run.
                    // Then start running again later.
                    // Check if code can continue.
                    setTimeout(tryToStart, 10);
                }
            } else {
                document.getElementById('stopButton').disabled = 'disabled';
                document.getElementById('runButton').disabled = '';
                document.getElementById('runFullSpeedButton').disabled = '';
                document.getElementById('stopButtonBlocks').disabled = 'disabled';
                document.getElementById('runButtonBlocks').disabled = '';
                document.getElementById('runFullSpeedButtonBlocks').disabled = '';
            }
        }
    </script>
</body>

</html>