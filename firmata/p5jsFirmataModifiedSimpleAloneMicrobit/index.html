<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>P5JS playground for Microbit</title>
    <script src="libraries/p5.min.js" type="text/javascript"></script>
    <script src="libraries/p5.dom.min.js"></script>
    <script src="libraries/p5.sound.min.js"></script>
    <script src="libraries/p5.webusbFirmata.js" type="text/javascript"></script>
    <script src="libraries/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="libraries/FileSaver.js" type="text/javascript"></script>
</head>

<body>


    <div id="editor" style="height: 400px; width: 600px;"></div>
    <button onclick="runCode()" id="runButton">Run code</button>
    <button onclick="uploadCode()" id="uploadButton">Upload code</button>
    <button onclick="downloadCode()" id="downloadButton">Download code</button>
    <input type='file' id="fileid" hidden/>
    <div id="iframeContainer">
        <iframe id="testFrame" style="height: 400px; width: 600px;" allow="usb">
            <p>Your browser does not support iframes.</p>
        </iframe>
    </div>

    <script>
        function runCode() {
            var metas = document.getElementsByTagName('meta');
            var metaStr = '<meta charset="utf-8">\n';
            var test;
            for (var i = 0; i < metas.length; i++) {
                if (metas[i].httpEquiv == 'origin-trial') {
                    metaStr = metaStr + '<meta http-equiv="origin-trial" data-feature="' + metas[i].dataset.feature + '" data-expires="' + metas[i].dataset.expires + '" content="' + metas[i].content + '">';
                }
            }

            var html = '';
            var css = '';
            var js = 'window.onerror = function (message, file, line, col, error) { alert("Error occurred: " + error.message + "\\non line: " + line); return false;};' + editor.getValue();

            var p5lib = '<script src="libraries\/p5.min.js" type="text\/javascript"><\/script><script src="libraries\/p5.dom.min.js"><\/script><script src="libraries\/p5.sound.min.js"><\/script><script src="libraries\/firmataHelper.js" type="text\/javascript"><\/script>';
            var webusbFirmataLib = '';

            var result = '<html><head>' + metaStr + p5lib + webusbFirmataLib + '<style>' + css + '</style></head><body>' + html + '<script type="text/javascript">' + js + '<\/script><\/body><\/html>';

            var iframe = document.getElementById('testFrame');
            iframe.style.display = 'none';

            var existIframe = document.getElementById('testFrameDup');
            if (existIframe) document.getElementById('iframeContainer').removeChild(existIframe);

            var iframeDup = iframe.cloneNode(true);
            iframeDup.style.display = 'block';
            iframeDup.id = "testFrameDup"
            document.getElementById('iframeContainer').appendChild(iframeDup);

            if (iframeDup.contentDocument) doc = iframeDup.contentDocument;
            else if (iframeDup.contentWindow) doc = iframeDup.contentWindow.document;
            else doc = iframeDup.document;

            doc.open();
            doc.writeln(result);
            doc.close();

            webusbFirmata.connect();
        }


        var client = new XMLHttpRequest();

        window.onload = function () {
            var loadFileName = 'sketch_default.js';

            try {
                var pidValue = decodeURIComponent(window.location.search.match(/(\?|&)pid\=([^&]*)/)[2]);
                var vidValue = decodeURIComponent(window.location.search.match(/(\?|&)vid\=([^&]*)/)[2]);
                var newDevice = {
                    'vendorId': parseInt(vidValue, 16)
                    , 'productId': parseInt(pidValue, 16)
                };
                usbfiltersilters.push(newDevice);
            } catch (err) {}


            try {
                var parameterValue = decodeURIComponent(window.location.search.match(/(\?|&)file\=([^&]*)/)[2]);
                loadFileName = parameterValue;
            } catch (err) {}

            editor = ace.edit("editor");
            editor.getSession().setMode("ace/mode/javascript");
            editor.getSession().setTabSize(2);
            editor.getSession().setUseWrapMode(true);

            client.open('GET', loadFileName);
            client.onreadystatechange = function () {
                if (client.readyState === XMLHttpRequest.DONE && client.status === 200) {
                    editor.setValue(client.responseText);
                    editor.navigateFileStart();
                } else {}
            }
            client.send();
        }
        var webusbFirmata;

        webusbFirmata = new p5.WebusbFirmata(); // make a new instance of the Makesense library

        //upload and download files
        function downloadCode() {
            var blob = new Blob([editor.getValue()], {
                type: "text/plain;charset=utf-8"
            });
            saveAs(blob, "code.js");
        }

        function uploadCode() {
            // Check for the various File API support.
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
                document.getElementById('fileid').click();
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }
        }


        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object
            for (var i = 0, f; f = files[i]; i++) {
                if (!(f.type.match('text.*') || f.type.match('.*javascript'))) {
                    continue;
                }

                var reader = new FileReader();
                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        editor.setValue(e.target.result);
                    };
                })(f);
                // Read in the image file as a data URL.
                reader.readAsText(f);
            }
        }

        document.getElementById('fileid').addEventListener('change', handleFileSelect, false);
    </script>
</body>

</html>