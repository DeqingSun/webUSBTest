<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>test Detection Camera Example</title>
    <script src="utils.js" type="text/javascript"></script>
</head>

<body>
    <div>
        <video id="videoInput" class="hidden">Your browser does not support the video tag.</video>
    </div>
    <div> valid block need to have change larger than
        <input type="range" min="1" max="10" value="2" step="0.1" class="slider" id="sliderMultiply" oninput="this.nextElementSibling.value = this.value">
        <output>2</output> times of the
        <input type="range" min="1" max="64" value="16" class="slider" id="sliderNtop" oninput="this.nextElementSibling.value = this.value">
        <output>16</output> th largest block </div>
    <canvas id="canvasOutput" width="640" height="480"></canvas>
    <div id="debugIndo">debug info</div>
    <div>
        <input type="range" min="100" max="5000" value="1500" class="slider" id="sliderTrigCool" oninput="this.nextElementSibling.value = this.value">
        <output>1500</output> ms retrigger cooldown </div>
    <div> <img src="" id="imgDisp1"> <img src="" id="imgDisp2"> <img src="" id="imgDisp3"></div>
    <script type="text/javascript">
        let utils = new Utils('errorMessage');
        let video = document.getElementById('videoInput');
        let vc = null;
        var roiIndex = [48 + 1, 48 + 3, 48 + 5];
        var triggerCount = [0, 0, 0]
        var triggerLimit = 4;
        var triggerValue = [false, false, false];
        var previousTriggerTimes = [new Date(), new Date(), new Date()];

        function startVideoProcessing() {
            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let currentFrame = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let prevFrame = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let diffFrame = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let diffGray = new cv.Mat(video.height, video.width, cv.CV_8UC1);
            let integralSum = new cv.Mat();
            let displayMat = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let sectionPoints = [];
            let sectionDiff = [];
            let sectionMove = [];
            //div image to 8*8
            var videoXstep = video.width / 8;
            var videoYstep = video.height / 8;
            for (var j = 0; j < 8; j++) {
                for (var i = 0; i < 8; i++) {
                    var index = j * 8 + i;
                    var startX = i * videoXstep;
                    var endX = (i + 1) * videoXstep - 1;
                    var startY = j * videoYstep;
                    var endY = (j + 1) * videoYstep - 1;
                    sectionPoints.push([new cv.Point(startX, startY), new cv.Point(endX, endY)]);
                    sectionDiff.push(0);
                }
            }
            let redColor = new cv.Scalar(255, 0, 0, 255);
            let yellowColor = new cv.Scalar(255, 255, 0, 255);
            let greenColor = new cv.Scalar(0, 255, 0, 255);
            let cap = new cv.VideoCapture(video);
            const FPS = 30;

            function getSumOfArea(integralResult, x1, y1, x2, y2) {
                var valBottomRight = integralResult.intAt(y2 + 1, x2 + 1);
                var valTopLeft = integralResult.intAt(y1 + 1, x1 + 1);
                var valTopRight = integralResult.intAt(y1, x2 + 1);
                var valBottomLeft = integralResult.intAt(y2 + 1, x1);
                return valBottomRight + valTopLeft - valTopRight - valBottomLeft;
            }

            function median(numbers) {
                const sorted = numbers.slice().sort((a, b) => a - b);
                const middle = Math.floor(sorted.length / 2);
                if (sorted.length % 2 === 0) {
                    return (sorted[middle - 1] + sorted[middle]) / 2;
                }
                return sorted[middle];
            }

            function getTopN(values, n) {
                const sorted = values.slice().sort((a, b) => a - b);
                return sorted[sorted.length - 1 - n];
            }

            function processVideo() {
                try {
                    let begin = Date.now();
                    // start processing.
                    cap.read(src);
                    cv.cvtColor(src, currentFrame, cv.COLOR_RGBA2RGB);
                    cv.absdiff(currentFrame, prevFrame, diffFrame)
                    currentFrame.copyTo(prevFrame);
                    cv.flip(diffFrame, diffFrame, 1);
                    cv.cvtColor(diffFrame, diffGray, cv.COLOR_RGB2GRAY);
                    cv.integral(diffGray, integralSum, cv.CV_32S);
                    if (integralSum.intAt(video.height, video.width) > 0) { //skip if identical img
                        //
                        cv.cvtColor(diffGray, displayMat, cv.COLOR_GRAY2RGB);
                        for (var i = 0; i < 64; i++) {
                            sectionCorners = sectionPoints[i];
                            sectionDiff[i] = getSumOfArea(integralSum, sectionCorners[0].x, sectionCorners[0].y, sectionCorners[1].x, sectionCorners[1].y);
                        }
                        var topNValue = document.getElementById("sliderNtop").value;
                        var topNMultiply = document.getElementById("sliderMultiply").value;
                        var topN = getTopN(sectionDiff, topNValue);
                        //console.log(sectionDiff,medianDiff)
                        for (var i = 0; i < 64; i++) {
                            sectionCorners = sectionPoints[i];
                            sectionMove[i] = (sectionDiff[i] > (topN * topNMultiply));
                            if (sectionMove[i]) {
                                cv.rectangle(displayMat, sectionCorners[0], sectionCorners[1], greenColor, 1);
                            }
                            else {
                                if (roiIndex.includes(i)) {
                                    cv.rectangle(displayMat, sectionCorners[0], sectionCorners[1], yellowColor, 2);
                                }
                                else {
                                    cv.rectangle(displayMat, sectionCorners[0], sectionCorners[1], redColor, 1);
                                }
                            }
                        }
                        //do tracking
                        {
                            for (var i = 0; i < 3; i++) {
                                var index = roiIndex[i];
                                if (sectionMove[index]) {
                                    triggerCount[i]++;
                                    if (triggerCount[i] > triggerLimit) {
                                        triggerCount[i] = triggerLimit;
                                    }
                                }
                                else {
                                    triggerCount[i] -= 2;
                                    if (triggerCount[i] < 0) {
                                        triggerCount[i] = 0;
                                    }
                                }
                                if (triggerValue[i]) {
                                    if (triggerCount[i] == 0) {
                                        triggerValue[i] = false;
                                        console.log("Area " + i + " released")
                                    }
                                }
                                else {
                                    if (triggerCount[i] >= triggerLimit) {
                                        triggerValue[i] = true;
                                        var previousTriggerTime = previousTriggerTimes[i];
                                        var triggerTime = new Date();
                                        var diff = triggerTime - previousTriggerTime;
                                        previousTriggerTimes[i] = triggerTime;
                                        console.log("Area " + i + " pressed. diff: " + diff);
                                        var thresholdDiff = document.getElementById("sliderTrigCool").value;
                                        if (diff >= thresholdDiff) {
                                            incImageIndex(i);
                                        }
                                    }
                                }
                            }
                        }
                        //currentFrame.copyTo(dst);
                        cv.imshow('canvasOutput', displayMat);
                        //show debug info
                        {
                            const sorted = sectionDiff.slice().sort((a, b) => a - b);
                            document.getElementById("debugIndo").innerHTML = "min:" + sorted[0] + " max:" + sorted.at(-1) + " median:" + sorted[sorted.length / 2] + " big" + topNValue + "th:" + topN;
                        }
                        // schedule the next one.
                    }
                    let delay = 1000 / FPS - (Date.now() - begin);
                    setTimeout(processVideo, delay);
                }
                catch (err) {
                    console.log(err);
                }
            };
            // schedule the first one.
            setTimeout(processVideo, 0);
        }
        utils.loadOpenCv(() => {
            //console.log(cv.getBuildInformation());
            utils.startCamera('qvga', onVideoStarted, 'videoInput');
            prepareImgs();
        });

        function onVideoStarted() {
            height = video.videoHeight;
            width = video.videoWidth;
            video.setAttribute('width', width);
            video.setAttribute('height', height);
            vc = new cv.VideoCapture(video);
            startVideoProcessing();
        }
        //image switch code
        var cImagesPath = []
        var nImagePath = []
        var picImagesPath = []
        var nImageIndex = 0;
        var cImagesImageIndex = 0;
        var picImagesPathImageIndex = 0;

        function prepareImgs() {
            for (var i = 0; i < 3; i++) {
                nImagePath[i] = "https://www.elasticmind.com/glassmouse/REZones/assets/n/" + i + ".png";
            }
            for (var j = 0; j < 3; j++) {
                cImagesPath[j] = []
                for (var k = 0; k < 3; k++) {
                    var fn = "https://www.elasticmind.com/glassmouse/REZones/assets/n/" + j + "/" + k + ".png"
                    cImagesPath[j][k] = (fn)
                }
            }
            for (var m = 0; m < 3; m++) {
                picImagesPath[m] = []
                for (var n = 0; n < 3; n++) {
                    picImagesPath[m][n] = []
                    for (var l = 0; l < 3; l++) {
                        var fname = "https://www.elasticmind.com/glassmouse/REZones/assets/n/" + m + "/" + n + "/" + l + ".png"
                        picImagesPath[m][n][l] = (fname)
                    }
                }
            }
            updateImgs();
        }

        function incImageIndex(i) {
            if (i == 0) {
                nImageIndex = (nImageIndex + 1) % 3;
            }
            if (i == 1) {
                cImagesImageIndex = (cImagesImageIndex + 1) % 3;
            }
            if (i == 2) {
                picImagesPathImageIndex = (picImagesPathImageIndex + 1) % 3;
            }
            updateImgs();
        }

        function updateImgs() {
            document.getElementById("imgDisp1").src = nImagePath[nImageIndex];
            document.getElementById("imgDisp2").src = cImagesPath[nImageIndex][cImagesImageIndex];
            document.getElementById("imgDisp3").src = picImagesPath[nImageIndex][cImagesImageIndex][picImagesPathImageIndex];
        }
    </script>
</body>

</html>