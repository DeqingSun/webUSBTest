<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>test Detection Camera Example</title>
    <script src="utils.js" type="text/javascript"></script>
    <script>
        //replace PHP here

let ar = [[{"src":"p/0.jpg"},{"src":"p/1.jpg"},{"src":"p/10.jpg"},{"src":"p/2.jpg"},{"src":"p/3.jpg"},{"src":"p/4.jpg"},{"src":"p/5.jpg"},{"src":"p/6.jpg"},{"src":"p/7.jpg"},{"src":"p/8.jpg"},{"src":"p/9.jpg"},],[{"src":"r/0.jpg"},{"src":"r/1.jpg"},{"src":"r/10.jpg"},{"src":"r/2.jpg"},{"src":"r/3.jpg"},{"src":"r/4.jpg"},{"src":"r/5.jpg"},{"src":"r/6.jpg"},{"src":"r/7.jpg"},{"src":"r/8.jpg"},{"src":"r/9.jpg"},],];
        
    </script>
</head>

<body>
    <div style="width: 95vw;height: 85vh;max-height: 85vh;border:none"> <img src="" id="imgDisp" style="width: 100%;height: 100%;object-fit: contain;"></div>
    <div style="width: 100%;border:none;">
        <canvas id="canvasOutput" width="640" height="480" style="padding: 0;margin:auto;display: block;"></canvas>
    </div>
    <div id="parameterPanel" style="display:none">
        <div> valid block need to have change larger than
            <input type="range" min="1" max="10" value="2" step="0.1" class="slider" id="sliderMultiply" oninput="this.nextElementSibling.value = this.value">
            <output>2</output> times of the
            <input type="range" min="1" max="64" value="16" class="slider" id="sliderNtop" oninput="this.nextElementSibling.value = this.value">
            <output>16</output> th largest block </div>
        <input type="range" min="100" max="5000" value="400" class="slider" id="sliderTrigCool" oninput="this.nextElementSibling.value = this.value">
        <output>400</output> ms retrigger cooldown
        <div id="debugIndo">debug info</div>
        <div>
            <table>
                <! –– 1*2 table ––>
                <tr>
                    <th>
                        <video id="videoInput" class="hidden">Your browser does not support the video tag.</video>
                    </th>
                    <th>
                        <! –– 8*8 table for data ––>
                        <table border='1' style='border-collapse:collapse;'>
                            <tr>
                                <th id="debugTable0" style="width:65px;">cell 0</th>
                                <th id="debugTable1" style="width:65px;">cell 1</th>
                                <th id="debugTable2" style="width:65px;">cell 2</th>
                                <th id="debugTable3" style="width:65px;">cell 3</th>
                                <th id="debugTable4" style="width:65px;">cell 4</th>
                                <th id="debugTable5" style="width:65px;">cell 5</th>
                                <th id="debugTable6" style="width:65px;">cell 6</th>
                                <th id="debugTable7" style="width:65px;">cell 7</th>
                            </tr>
                            <tr>
                                <th id="debugTable8">cell 8</th>
                                <th id="debugTable9">cell 9</th>
                                <th id="debugTable10">cell 10</th>
                                <th id="debugTable11">cell 11</th>
                                <th id="debugTable12">cell 12</th>
                                <th id="debugTable13">cell 13</th>
                                <th id="debugTable14">cell 14</th>
                                <th id="debugTable15">cell 15</th>
                            </tr>
                            <tr>
                                <th id="debugTable16">cell 16</th>
                                <th id="debugTable17">cell 17</th>
                                <th id="debugTable18">cell 18</th>
                                <th id="debugTable19">cell 19</th>
                                <th id="debugTable20">cell 20</th>
                                <th id="debugTable21">cell 21</th>
                                <th id="debugTable22">cell 22</th>
                                <th id="debugTable23">cell 23</th>
                            </tr>
                            <tr>
                                <th id="debugTable24">cell 24</th>
                                <th id="debugTable25">cell 25</th>
                                <th id="debugTable26">cell 26</th>
                                <th id="debugTable27">cell 27</th>
                                <th id="debugTable28">cell 28</th>
                                <th id="debugTable29">cell 29</th>
                                <th id="debugTable30">cell 30</th>
                                <th id="debugTable31">cell 31</th>
                            </tr>
                            <tr>
                                <th id="debugTable32">cell 32</th>
                                <th id="debugTable33">cell 33</th>
                                <th id="debugTable34">cell 34</th>
                                <th id="debugTable35">cell 35</th>
                                <th id="debugTable36">cell 36</th>
                                <th id="debugTable37">cell 37</th>
                                <th id="debugTable38">cell 38</th>
                                <th id="debugTable39">cell 39</th>
                            </tr>
                            <tr>
                                <th id="debugTable40">cell 40</th>
                                <th id="debugTable41">cell 41</th>
                                <th id="debugTable42">cell 42</th>
                                <th id="debugTable43">cell 43</th>
                                <th id="debugTable44">cell 44</th>
                                <th id="debugTable45">cell 45</th>
                                <th id="debugTable46">cell 46</th>
                                <th id="debugTable47">cell 47</th>
                            </tr>
                            <tr>
                                <th id="debugTable48">cell 48</th>
                                <th id="debugTable49">cell 49</th>
                                <th id="debugTable50">cell 50</th>
                                <th id="debugTable51">cell 51</th>
                                <th id="debugTable52">cell 52</th>
                                <th id="debugTable53">cell 53</th>
                                <th id="debugTable54">cell 54</th>
                                <th id="debugTable55">cell 55</th>
                            </tr>
                            <tr>
                                <th id="debugTable56">cell 56</th>
                                <th id="debugTable57">cell 57</th>
                                <th id="debugTable58">cell 58</th>
                                <th id="debugTable59">cell 59</th>
                                <th id="debugTable60">cell 60</th>
                                <th id="debugTable61">cell 61</th>
                                <th id="debugTable62">cell 62</th>
                                <th id="debugTable63">cell 63</th>
                            </tr>
                        </table>
                    </th>
                </tr>
            </table>
        </div>
    </div>
    <script type="text/javascript">
        let utils = new Utils('errorMessage');
        let video = document.getElementById('videoInput');
        let vc = null;
        var roiIndex = [48 + 1, 48 + 5]; //For Steve: this shows which block need to be tracked. The blocks are numbered horizontally.
        var roiDoubleBoxes = [true, true];
        var roiDoubleBoxValueScale = 1.5;
        var triggerCount = [0, 0, 0];
        var triggerLimit = 4;
        var triggerValue = [false, false, false];
        var previousTriggerTimes = [new Date(), new Date(), new Date()];
        var triggerLessDisplay = true;
        var showingDebug = false;

        function startVideoProcessing() {
            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let currentFrame = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let prevFrame = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let diffFrame = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let diffGray = new cv.Mat(video.height, video.width, cv.CV_8UC1);
            let integralSum = new cv.Mat();
            let displayMat = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let sectionPoints = [];
            let sectionDiff = [];
            let sectionMove = [];
            let displayMatCrop = new cv.Mat();
            //div image to 8*8
            var videoXstep = video.width / 8;
            var videoYstep = video.height / 8;
            for (var j = 0; j < 8; j++) {
                for (var i = 0; i < 8; i++) {
                    var index = j * 8 + i;
                    var startX = i * videoXstep;
                    var endX = (i + 1) * videoXstep - 1;
                    var startY = j * videoYstep;
                    var endY = (j + 1) * videoYstep - 1;
                    sectionPoints.push([new cv.Point(startX, startY), new cv.Point(endX, endY)]);
                    sectionDiff.push(0);
                }
            }
            let redColor = new cv.Scalar(255, 0, 0, 255);
            let yellowColor = new cv.Scalar(255, 255, 0, 255);
            let greenColor = new cv.Scalar(0, 255, 0, 255);
            let cap = new cv.VideoCapture(video);
            const FPS = 30;

            function getSumOfArea(integralResult, x1, y1, x2, y2) {
                var valBottomRight = integralResult.intAt(y2 + 1, x2 + 1);
                var valTopLeft = integralResult.intAt(y1 + 1, x1 + 1);
                var valTopRight = integralResult.intAt(y1, x2 + 1);
                var valBottomLeft = integralResult.intAt(y2 + 1, x1);
                return valBottomRight + valTopLeft - valTopRight - valBottomLeft;
            }

            function median(numbers) {
                const sorted = numbers.slice().sort((a, b) => a - b);
                const middle = Math.floor(sorted.length / 2);
                if (sorted.length % 2 === 0) {
                    return (sorted[middle - 1] + sorted[middle]) / 2;
                }
                return sorted[middle];
            }

            function getTopN(values, n) {
                const sorted = values.slice().sort((a, b) => a - b);
                return sorted[sorted.length - 1 - n];
            }

            function processVideo() {
                try {
                    let begin = Date.now();
                    // start processing.
                    cap.read(src);
                    cv.cvtColor(src, currentFrame, cv.COLOR_RGBA2RGB);
                    cv.flip(currentFrame, currentFrame, 1);
                    cv.absdiff(currentFrame, prevFrame, diffFrame)
                    currentFrame.copyTo(prevFrame);
                    cv.cvtColor(diffFrame, diffGray, cv.COLOR_RGB2GRAY);
                    cv.integral(diffGray, integralSum, cv.CV_32S);
                    if (integralSum.intAt(video.height, video.width) > 0) { //skip if identical img
                        //
                        //cv.cvtColor(diffGray, displayMat, cv.COLOR_GRAY2RGB);
                        currentFrame.copyTo(displayMat);
                        for (let i = 0; i < 64; i++) {
                            let sectionCorners = sectionPoints[i];
                            sectionDiff[i] = getSumOfArea(integralSum, sectionCorners[0].x, sectionCorners[0].y, sectionCorners[1].x, sectionCorners[1].y);
                        }
                        //output diff to debug
                        if (document.getElementById("parameterPanel").style.display != "none") {
                            for (let i = 0; i < 64; i++) {
                                document.getElementById("debugTable" + i).innerHTML = sectionDiff[i];
                            }
                        }
                        var topNValue = document.getElementById("sliderNtop").value;
                        var topNMultiply = document.getElementById("sliderMultiply").value;
                        var topN = getTopN(sectionDiff, topNValue);
                        //console.log(sectionDiff,medianDiff)
                        for (let i = 0; i < 64; i++) {
                            let sectionCorners = sectionPoints[i];
                            let sectionStartCorner = sectionCorners[0];
                            let sectionEndCorner = sectionCorners[1];
                            let sectionScale = 1;
                            let thisSectionDiff = sectionDiff[i];
                            if (roiIndex.includes(i)) {
                                let indexInRoiIndex = roiIndex.indexOf(i);
                                if (roiDoubleBoxes[indexInRoiIndex]) {
                                    sectionEndCorner = sectionPoints[i + 1][1];
                                    sectionScale = roiDoubleBoxValueScale;
                                    thisSectionDiff += sectionDiff[i + 1];
                                }
                            }
                            sectionMove[i] = (thisSectionDiff > (topN * topNMultiply * sectionScale));
                            if (showingDebug || roiIndex.includes(i)) {
                                if (sectionMove[i]) {
                                    cv.rectangle(displayMat, sectionStartCorner, sectionEndCorner, greenColor, 1);
                                }
                                else {
                                    if (roiIndex.includes(i)) {
                                        cv.rectangle(displayMat, sectionStartCorner, sectionEndCorner, yellowColor, 2);
                                    }
                                    else {
                                        cv.rectangle(displayMat, sectionStartCorner, sectionEndCorner, redColor, 1);
                                    }
                                }
                            }
                        }
                        //do tracking
                        {
                            for (var i = 0; i < roiIndex.length; i++) {
                                var index = roiIndex[i];
                                if (sectionMove[index]) {
                                    triggerCount[i]++;
                                    if (triggerCount[i] > triggerLimit) {
                                        triggerCount[i] = triggerLimit;
                                    }
                                }
                                else {
                                    triggerCount[i] -= 2;
                                    if (triggerCount[i] < 0) {
                                        triggerCount[i] = 0;
                                    }
                                }
                                if (triggerValue[i]) {
                                    if (triggerCount[i] == 0) {
                                        triggerValue[i] = false;
                                        console.log("Area " + i + " released")
                                    }
                                }
                                else {
                                    if (triggerCount[i] >= triggerLimit) {
                                        triggerValue[i] = true;
                                        var previousTriggerTime = previousTriggerTimes[i];
                                        var triggerTime = new Date();
                                        var diff = triggerTime - previousTriggerTime;
                                        previousTriggerTimes[i] = triggerTime;
                                        console.log("Area " + i + " pressed. diff: " + diff);
                                        var thresholdDiff = document.getElementById("sliderTrigCool").value;
                                        if (diff >= thresholdDiff) {
                                            incImageIndex(i);
                                        }
                                    }
                                }
                            }
                        }
                        //currentFrame.copyTo(dst);
                        if (triggerLessDisplay) {
                            var displayHeight = displayMat.rows / 8 * 3;
                            let rect = new cv.Rect(0, displayMat.rows - displayHeight, displayMat.cols, displayHeight);
                            displayMatCrop = displayMat.roi(rect);
                            cv.imshow('canvasOutput', displayMatCrop);
                        }
                        else {
                            cv.imshow('canvasOutput', displayMat);
                        }
                        //show debug info
                        {
                            const sorted = sectionDiff.slice().sort((a, b) => a - b);
                            document.getElementById("debugIndo").innerHTML = "min:" + sorted[0] + " max:" + sorted[sorted.length - 1] + " median:" + sorted[sorted.length / 2] + " big" + topNValue + "th:" + topN;
                        }
                        // schedule the next one.
                    }
                    let delay = 1000 / FPS - (Date.now() - begin);
                    setTimeout(processVideo, delay);
                }
                catch (err) {
                    console.log(err);
                }
            };
            // schedule the first one.
            setTimeout(processVideo, 0);
        }
        utils.loadOpenCv(() => {
            //console.log(cv.getBuildInformation());
            utils.startCamera('qvga', onVideoStarted, 'videoInput');
            prepareImgs();
            document.addEventListener("keydown", e => {
                if (e.key == 'd' || e.key == 'D') {
                    var debugDiv = document.getElementById("parameterPanel");
                    if (debugDiv.style.display == "none") {
                        debugDiv.style.display = "";
                        showingDebug = true;
                    }
                    else {
                        debugDiv.style.display = "none";
                        showingDebug = false;
                    }
                }
            })
        });

        function onVideoStarted() {
            height = video.videoHeight;
            width = video.videoWidth;
            video.setAttribute('width', width);
            video.setAttribute('height', height);
            vc = new cv.VideoCapture(video);
            startVideoProcessing();
        }
        //image switch code
        var artistIndex = 0;
        var artistImageIndex = 0;

        function prepareImgs() {
            updateImgs();
        }

        function incImageIndex(i) { //For Steve: this is how the code reacts to the swipe events
            if (i == 0) {
                artistIndex++;
                if (artistIndex >= ar.length) {
                    artistIndex = 0;
                }
                artistImageIndex = 0;
            }
            if (i == 1) {
                artistImageIndex++;
                if (artistImageIndex >= ar[artistIndex].length) {
                    artistImageIndex = 0;
                }
            }
            updateImgs();
        }

        function updateImgs() {
            document.getElementById("imgDisp").src = ar[artistIndex][artistImageIndex].src;
        }
    </script>
</body>

</html>