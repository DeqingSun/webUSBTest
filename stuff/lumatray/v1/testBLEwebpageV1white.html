<!DOCTYPE HTML>
<html>

<head>
    <title>webBluetooth for reading</title>
    <script>
        //generate template on https://beaufortfrancois.github.io/sandbox/web-bluetooth/generator/

        class LumaTrayBLEDevice {

            constructor() {
                this.device = null;
                this.onDisconnected = this.onDisconnected.bind(this);
                this.ledSending = false;
                this.ledQueue = [];
            }

            async request() {
                let options = {
                    "filters": [{
                        "services": ['4acdc426-31b0-4540-b15c-5803d278b32e']
                    }]
                };

                var device = await navigator.bluetooth.requestDevice(options)
                this.device = device;
                this.device.addEventListener('gattserverdisconnected', this.onDisconnected);

                return device;
            }

            connect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.connect();
            }

            async findLedCharacteristic() {
                var service = await this.device.gatt.getPrimaryService('4acdc426-31b0-4540-b15c-5803d278b32e');
                this.ledCharacteristic = await service.getCharacteristic('1e626fa6-6684-11eb-ae93-0242ac130002');
            }

            async writeLedService(data) {
                await this.ledCharacteristic.writeValue(data);
            }


            disconnect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.disconnect();
            }

            onDisconnected() {
                console.log('Device is disconnected.');
            }
        }

        var lumaTrayBLEDevice = new LumaTrayBLEDevice();

        document.addEventListener("DOMContentLoaded", function (event) {

        });

        async function connectButtonHandler(event) {
            try {
                await lumaTrayBLEDevice.request();
                await lumaTrayBLEDevice.connect();
                await lumaTrayBLEDevice.findLedCharacteristic();
                //Do something with testBLEDevice...
            } catch (e) {
                console.error(e);
            }
        }

        async function writeButtonHandler(event) {

            //brightness, mode, direction, strength, r, g, b
            var bytes = getDataFromSilder();

            var buffer = new Uint8Array(bytes).buffer;
            var data = new DataView(buffer);
            lumaTrayBLEDevice.ledQueue.push(data);

            if (!lumaTrayBLEDevice.ledSending) {
                lumaTrayBLEDevice.ledSending = true;
                try {
                    while (lumaTrayBLEDevice.ledQueue.length > 0) {
                        lastElement = lumaTrayBLEDevice.ledQueue.pop();
                        lumaTrayBLEDevice.ledQueue.length = 0;
                        await lumaTrayBLEDevice.writeLedService(lastElement);
                    }
                } catch (e) {
                    console.error(e);
                }
                lumaTrayBLEDevice.ledSending = false;
            }
        }

        function getDataFromSilder() {
            var briVal = parseInt(document.getElementById('brightnessRange').value);
            var modeVal = parseInt(document.getElementById('modeRange').value);
            var dirVal = parseInt(document.getElementById('directionRange').value);
            var strVal = parseInt(document.getElementById('strengthRange').value);
            var neutralVal = parseInt(document.getElementById('whiteNeutralRange').value);
            var warmVal = parseInt(document.getElementById('whiteWarmRange').value);

            var bytes = [briVal, modeVal, dirVal, strVal, neutralVal, warmVal];
            return bytes;
        }

        function modeSilderChangeHandler(val) {
            modeString = ["Just ON", "FLASH", "ORBIT", "RGB CYCLE", "RAINBOW"]
            document.getElementById('modeText').innerHTML = modeString[val]
        }

        function silderChangeHandler(sliderObj) {
            if (sliderObj.id == "modeRange") {
                modeSilderChangeHandler(sliderObj.value);
            }
            if (document.getElementById('autoWrite').checked) {
                writeButtonHandler();
            }
        }

        /*color temperature test*/

        //LW Y87C-S1T2-3K8L-Z 0.33 0.33 180~450mcd, first we use the middle 315mcd
        //SMS1105UWDW 0.44 0.44 1500~2000mcd, first we use the middle 1750mcd  (much more brighter)


        class LEDStruct {

            set_x_y_bri(x, y, bri) {
                this.x = x
                this.y = y
                this.bri = bri
            }
            set_X_Y_Z(X, Y, Z) {
                this.X = X
                this.Y = Y
                this.Z = Z
            }
            convert3D() {
                this.Y = this.bri;
                this.X = this.x / this.y * this.Y;
                this.Z = (1 - this.x - this.y) / this.y * this.Y;
            }
            convert2D() {
                this.x = this.X / (this.X + this.Y + this.Z);
                this.y = this.Y / (this.X + this.Y + this.Z);
                this.bri = this.Y;
            }
            mixFrom2LED(led1, ratio1, led2, ratio2) {
                this.X = led1.X * ratio1 + led2.X * ratio2;
                this.Y = led1.Y * ratio1 + led2.Y * ratio2;
                this.Z = led1.Z * ratio1 + led2.Z * ratio2;
                this.convert2D()
            }
        }
        var neutralLED = new LEDStruct();
        var warmLED = new LEDStruct();
        var mixedLED = new LEDStruct();
        neutralLED.set_x_y_bri(0.33, 0.33, 315);
        warmLED.set_x_y_bri(0.44, 0.44, 1750);
        neutralLED.convert3D();
        warmLED.convert3D();

        var allPossibleMixture = [];
        for (i = 0; i < 256; i++) {
            for (j = 0; j < 50; j++) {
                mixedLED.mixFrom2LED(neutralLED, i / 256.0, warmLED, j / 256.0);
                if ((mixedLED.bri > (315 * .98)) && (mixedLED.bri < (315 * 1.02))) {
                    allPossibleMixture.push([mixedLED.x, mixedLED.y, i, j])
                        //console.log(i, j, mixedLED.bri);
                }
            }
        }
        //console.log(allPossibleMixture)

        //mixedLED.mixFrom2LED(neutralLED,1,warmLED,.18);
        //console.log(mixedLED);

        function util_T_to_xy(t) {
            if ((t >= 4000 || true) && t <= 7000) { //just go beyond the 4000K restriction for now, todo: add more accurate algorithm
                x = -4.607E9 / (t * t * t) + 2.9678E6 / (t * t) + 0.09911E3 / (t) + 0.244063;
                y = -3.000 * x * x + 2.870 * x - 0.275
                return [x, y]
            } else if (t >= 7000 && t <= 25000) {
                x = -2.0064E9 / (t * t * t) + 1.9018E6 / (t * t) + 0.24748E3 / (t) + 0.237040;
                y = -3.000 * x * x + 2.870 * x - 0.275
                return [x, y]
            } else {
                return
            }
        }

        function white2MixTempSilderChangeHandler(sliderObj) {
            var tempVal = parseInt(document.getElementById('white2MixtempRange').value);
            document.getElementById('white2MixtempText').innerHTML = 'Temperature ' + tempVal;
            convertedXY = util_T_to_xy(tempVal)
            x = convertedXY[0]
            y = convertedXY[1]

            //console.log("conv", tempVal, x, y)

            //try to mix it with proximation


            var minDiff = 9999;
            var minDiffIndex = 0;
            for (var i = 0, l = allPossibleMixture.length; i < l; i++) {
                var xdiff = allPossibleMixture[i][0]-x
                var ydiff = allPossibleMixture[i][1]-y
                var dist = Math.sqrt(xdiff*xdiff+ydiff*ydiff)
                if (dist<minDiff){
                    minDiff=dist;
                    minDiffIndex=i;
                }
            }
            //console.log(allPossibleMixture[minDiffIndex])
            PWMn = allPossibleMixture[minDiffIndex][2]
            PWMw = allPossibleMixture[minDiffIndex][3]

            document.getElementById('whiteNeutralRange').value = PWMn;
            document.getElementById('whiteWarmRange').value = PWMw;

            if (document.getElementById('autoWrite').checked) {
                writeButtonHandler();
            }

        }
    </script>

</head>

<body>
    <button onclick="connectButtonHandler()" type="button" id='connectButton'>Connect</button>
    <br>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="brightnessRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Brightness
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="4" value="0" class="slider" id="modeRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Mode
        <p id="modeText">Just ON</p>
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="directionRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Direction
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="255" class="slider" id="strengthRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Strength
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="255" class="slider" id="whiteNeutralRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> 6200K white
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="255" class="slider" id="whiteWarmRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> 3200K white
    </div>
    <br>
    <div class="slidecontainer">
        <input type="range" min="3200" max="6000" value="4000" class="slider" id="white2MixtempRange" oninput="white2MixTempSilderChangeHandler(this)" onchange="white2MixTempSilderChangeHandler(this)">
        <div style='display: inline-block;' id="white2MixtempText">Temperature 4000</div>
    </div>
    <br>
    <br>
    <br>

    <button onclick="writeButtonHandler()" type="button" id='writeButton'>Write value</button>
    <br>
    <br>
    <input type="checkbox" id="autoWrite" checked>Auto Write


</body>

</html>