<!DOCTYPE HTML>
<html>

<head>
    <title>webBluetooth for reading</title>
    <script>
        //generate template on https://beaufortfrancois.github.io/sandbox/web-bluetooth/generator/
        class LumaTrayBLEDevice {
            constructor() {
                this.device = null;
                this.onDisconnected = this.onDisconnected.bind(this);
                this.ledSending = false;
                this.ledQueue = [];
            }
            async request() {
                let options = {
                    "filters": [{
                        "services": ['4acdc426-31b0-4540-b15c-5803d278b32e']
                    }]
                };
                var device = await navigator.bluetooth.requestDevice(options)
                this.device = device;
                this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
                return device;
            }
            connect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.connect();
            }
            async findLedCharacteristic() {
                var service = await this.device.gatt.getPrimaryService('4acdc426-31b0-4540-b15c-5803d278b32e');
                this.ledCharacteristic = await service.getCharacteristic('1e626fa6-6684-11eb-ae93-0242ac130002');
            }
            async writeLedService(data) {
                await this.ledCharacteristic.writeValue(data);
            }
            async readLedService(data) {
                return await this.ledCharacteristic.readValue();
            }
            disconnect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.disconnect();
            }
            onDisconnected() {
                console.log('Device is disconnected.');
            }
        }
        var lumaTrayBLEDevice = new LumaTrayBLEDevice();
        document.addEventListener("DOMContentLoaded", function (event) {});
        async function connectButtonHandler(event) {
            try {
                await lumaTrayBLEDevice.request();
                await lumaTrayBLEDevice.connect();
                await lumaTrayBLEDevice.findLedCharacteristic();
                //Do something with testBLEDevice...
            }
            catch (e) {
                console.error(e);
            }
        }
        async function writeButtonHandler(event) {
            //brightness, mode, direction, strength, r, g, b
            var bytes = getDataFromSilder();
            var buffer = new Uint8Array(bytes).buffer;
            var data = new DataView(buffer);
            if (lumaTrayBLEDevice.device == null) {
                return;
            }
            lumaTrayBLEDevice.ledQueue.push(data);
            if (!lumaTrayBLEDevice.ledSending) {
                lumaTrayBLEDevice.ledSending = true;
                try {
                    while (lumaTrayBLEDevice.ledQueue.length > 0) {
                        lastElement = lumaTrayBLEDevice.ledQueue.pop();
                        lumaTrayBLEDevice.ledQueue.length = 0;
                        await lumaTrayBLEDevice.writeLedService(lastElement);
                    }
                }
                catch (e) {
                    console.error(e);
                }
                lumaTrayBLEDevice.ledSending = false;
            }
        }

        function getDataFromSilder() {
            var briVal = parseInt(document.getElementById('brightnessRange').value);
            var modeVal = parseInt(document.getElementById('modeRange').value);
            var dirVal = parseInt(document.getElementById('directionRange').value);
            var strVal = parseInt(document.getElementById('strengthRange').value);
            var neutralVal = parseInt(document.getElementById('whiteNeutralRange').value);
            var warmVal = parseInt(document.getElementById('whiteWarmRange').value);
            if (document.getElementById('modeText').innerHTML == "FLASH") {
                var flashParameter1Val = parseInt(document.getElementById('flashParameter1Range').value);
                var flashParameter2Val = parseInt(document.getElementById('flashParameter2Range').value);
                var bytes = [briVal, modeVal, dirVal, strVal, neutralVal, warmVal, flashParameter1Val, flashParameter2Val, 0];
            }
            else if (document.getElementById('modeText').innerHTML == "PULSE") {
                var pulseParameter1Val = parseInt(document.getElementById('pulseParameter1Range').value);
                var pulseParameter2Val = parseInt(document.getElementById('pulseParameter2Range').value);
                var bytes = [briVal, modeVal, dirVal, strVal, neutralVal, warmVal, pulseParameter1Val, pulseParameter2Val, 0];
            }
            else if (document.getElementById('modeText').innerHTML == "ORBIT") {
                var orbitParameter1Val = parseInt(document.getElementById('orbitParameter1Range').value);
                var bytes = [briVal, modeVal, dirVal, strVal, neutralVal, warmVal, orbitParameter1Val, 0, 0];
            }
            else {
                var bytes = [briVal, modeVal, dirVal, strVal, neutralVal, warmVal];
            }
            return bytes;
        }

        function modeSilderChangeHandler(val) {
            modeString = ["Just ON", "FLASH", "PULSE", "ORBIT"];
            document.getElementById('modeText').innerHTML = modeString[val];
            document.getElementById('flashParameterContainer').hidden = (document.getElementById('modeText').innerHTML != "FLASH");
            document.getElementById('pulseParameterContainer').hidden = (document.getElementById('modeText').innerHTML != "PULSE");
            document.getElementById('orbitParameterContainer').hidden = (document.getElementById('modeText').innerHTML != "ORBIT");
        }

        function silderChangeHandler(sliderObj) {
            if (sliderObj.id == "modeRange") {
                modeSilderChangeHandler(sliderObj.value);
            }
            if (document.getElementById('autoWrite').checked) {
                writeButtonHandler();
            }
            setValueText();
        }
        /*color temperature test*/
        tempLookup = [
[106, 194], [99, 179], [101, 181], [109, 193], [104, 182], [111, 192], [110, 188], [103, 174]
, [104, 174], [107, 177], [114, 186], [112, 181], [111, 177], [119, 188], [114, 178], [117, 181]
, [116, 177], [123, 186], [113, 169], [114, 169], [115, 168], [124, 180], [125, 179], [117, 166]
, [124, 174], [123, 171], [124, 170], [128, 174], [125, 168], [133, 177], [123, 162], [131, 171]
, [134, 173], [123, 157], [126, 159], [128, 160], [135, 167], [130, 159], [127, 154], [141, 169]
, [138, 164], [137, 161], [142, 165], [145, 167], [144, 164], [139, 157], [146, 163], [141, 156]
, [148, 162], [142, 154], [151, 162], [142, 151], [138, 145], [142, 148], [152, 157], [140, 143]
, [155, 157], [142, 142], [142, 141], [158, 155], [147, 143], [158, 152], [150, 143], [158, 149]
, [158, 148], [158, 146], [158, 145], [152, 138], [159, 143], [163, 145], [152, 134], [156, 136]
, [169, 146], [160, 137], [163, 138], [168, 141], [172, 143], [163, 134], [162, 132], [175, 141]
, [160, 128], [172, 136], [162, 127], [169, 131], [178, 137], [180, 137], [179, 135], [165, 123]
, [181, 134], [179, 131], [172, 125], [174, 125], [170, 121], [172, 121], [175, 122], [181, 125]
, [171, 117], [180, 122], [189, 127], [191, 127], [178, 117], [192, 125], [186, 120], [178, 114]
, [177, 112], [191, 120], [182, 113], [193, 119], [197, 120], [189, 114], [184, 110], [191, 113]
, [198, 116], [193, 112], [188, 108], [185, 105], [197, 111], [203, 113], [201, 111], [187, 102]
, [205, 111], [202, 108], [196, 104], [208, 109], [198, 103], [202, 104], [206, 105], [214, 108]
, [194, 97], [194, 96], [196, 96], [217, 105], [215, 103], [213, 101], [219, 103], [209, 97]
, [215, 99], [215, 98], [204, 92], [204, 91], [213, 94], [213, 93], [224, 97], [210, 90]
, [210, 89], [210, 88], [219, 91], [222, 91], [219, 89], [209, 84], [229, 91], [229, 90]
, [231, 90], [231, 89], [220, 84], [231, 87], [217, 81], [225, 83], [227, 83], [238, 86]
, [224, 80], [226, 80], [223, 78], [220, 76], [243, 83], [222, 75], [242, 81], [221, 73]
, [245, 80], [223, 72], [247, 79], [228, 72], [227, 71], [250, 77], [242, 74], [236, 71]
, [245, 73], [238, 70], [230, 67], [254, 73], [239, 68], [243, 68], [242, 67], [248, 68]
, [233, 63], [243, 65], [254, 67], [249, 65], [244, 63], [255, 65], [254, 64], [254, 63]
, [240, 59], [249, 60], [255, 61], [247, 58], [250, 58], [244, 56], [248, 56], [251, 56]
, [250, 55], [253, 55], [247, 53], [251, 53], [254, 53], [252, 52], [252, 51], [249, 50]
, [254, 50], [251, 49], [251, 48], [254, 48], [252, 47], [255, 47], [254, 46], [254, 45]
, [255, 45], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44]
, [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44]
, [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44]
, [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44]
, [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44], [255, 44]
, ];

        function white2MixTempSilderChangeHandler(sliderObj) {
            var tempVal = parseInt(document.getElementById('white2MixtempRange').value);
            var startTemp = 3300
            var endTemp = 4700
            var calcTemp = startTemp + (endTemp - startTemp) * tempVal / 255.0
            calcTemp = Math.round(calcTemp)
            document.getElementById('white2MixtempText').innerHTML = 'Temperature ' + calcTemp;
            entry = tempLookup[tempVal];
            PWMn = entry[0]
            PWMw = entry[1]
            document.getElementById('whiteNeutralRange').value = PWMn;
            document.getElementById('whiteWarmRange').value = PWMw;
            if (document.getElementById('autoWrite').checked) {
                writeButtonHandler();
            }
        }
        var aaa;
        async function readButtonHandler(event) {
            //brightness, mode, direction, strength, r, g, b
            try {
                var data = await lumaTrayBLEDevice.readLedService();
                var dataLength = data.byteLength;
                if (dataLength >= 6) {
                    var briVal = data.getUint8(0);
                    document.getElementById('brightnessRange').value = briVal;
                    var modeVal = data.getUint8(1);
                    document.getElementById('modeRange').value = modeVal;
                    var dirVal = data.getUint8(2);
                    document.getElementById('directionRange').value = dirVal;
                    var strVal = data.getUint8(3);
                    document.getElementById('strengthRange').value = strVal;
                    var neutralVal = data.getUint8(4);
                    document.getElementById('whiteNeutralRange').value = neutralVal;
                    var warmVal = data.getUint8(5);
                    document.getElementById('whiteWarmRange').value = warmVal;
                    //differentMode additional code
                    if (modeVal == 1) {
                        if (dataLength >= (6 + 2)) {
                            modeSilderChangeHandler(modeVal);
                            var flashParameter1Val = data.getUint8(6);
                            document.getElementById('flashParameter1Range').value = flashParameter1Val;
                            var flashParameter2Val = data.getUint8(7);
                            document.getElementById('flashParameter2Range').value = flashParameter2Val;
                        }
                    }
                    else if (modeVal == 2) {
                        if (dataLength >= (6 + 2)) {
                            modeSilderChangeHandler(modeVal);
                            var pulseParameter1Val = data.getUint8(6);
                            document.getElementById('pulseParameter1Range').value = pulseParameter1Val;
                            var pulseParameter2Val = data.getUint8(7);
                            document.getElementById('pulseParameter2Range').value = pulseParameter2Val;
                        }
                    }
                    else if (modeVal == 3) {
                        if (dataLength >= (6 + 1)) {
                            modeSilderChangeHandler(modeVal);
                            var orbitParameter1Val = data.getUint8(6);
                            document.getElementById('orbitParameter1Range').value = orbitParameter1Val;
                        }
                    }
                    setValueText();
                }
            }
            catch (e) {
                console.error(e);
            }
        }

        function setValueText() {
            //brightness
            var briVal = parseInt(document.getElementById('brightnessRange').value);
            var briPercentage = (briVal * 100 / 255.0).toFixed(1);
            document.getElementById('brightnessText').innerHTML = briVal + ", " + briPercentage + "%";
            //direction
            var dirVal = parseInt(document.getElementById('directionRange').value);
            var dirAngle = (dirVal * 360 / 255.0).toFixed();
            document.getElementById('directionText').innerHTML = dirVal + ", " + dirAngle + " deg";
            //strength
            var strVal = parseInt(document.getElementById('strengthRange').value);
            var strPercentage = (strVal * 100 / 255.0).toFixed(1);
            document.getElementById('strengthText').innerHTML = strVal + ", " + strPercentage + "%";
            //flash
            var flashParameter1Val = parseInt(document.getElementById('flashParameter1Range').value);
            var flashParameter2Val = parseInt(document.getElementById('flashParameter2Range').value);
            var flashOnTime = flashParameter1Val * 10;
            var flashOffTime = flashParameter2Val * 10;
            document.getElementById('flashOnTimeText').innerHTML = flashParameter1Val + ", " + flashOnTime + "ms";
            document.getElementById('flashOffTimeText').innerHTML = flashParameter2Val + ", " + flashOffTime + "ms";
            //pulse
            var pulseParameter1Val = parseInt(document.getElementById('pulseParameter1Range').value);
            var pulseParameter2Val = parseInt(document.getElementById('pulseParameter2Range').value);
            var pulseInTime = pulseParameter1Val * 100;
            var pulseOutTime = pulseParameter2Val * 100;
            document.getElementById('pulseInTimeText').innerHTML = pulseParameter1Val + ", " + pulseInTime + "ms";
            document.getElementById('pulseOutTimeText').innerHTML = pulseParameter2Val + ", " + pulseOutTime + "ms";
            //orbit
            var orbitParameter1Val = parseInt(document.getElementById('orbitParameter1Range').value);
            var orbitRPM = (60000 * (orbitParameter1Val - 128) / (128 * 256)).toFixed(2);
            document.getElementById('orbitSpeedText').innerHTML = orbitParameter1Val + ", " + orbitRPM + "rpm";
        }
        document.addEventListener("DOMContentLoaded", function () {
            setValueText();
        });
    </script>
</head>

<body>
    <button onclick="connectButtonHandler()" type="button" id='connectButton'>Connect</button>
    <br>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="brightnessRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Brightness
        <label id="brightnessText">brightnessText</label>
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="3" value="0" class="slider" id="modeRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Mode
        <p id="modeText">Just ON</p>
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="directionRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Direction
        <label id="directionText">directionText</label>
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="255" class="slider" id="strengthRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Strength
        <label id="strengthText">strengthText</label>
    </div>
    <br>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="255" class="slider" id="whiteNeutralRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> 4808K white
        <div style="display: inline; color:WhiteSmoke;">SMS1105UWDN 1500 0.35 0.35</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="255" class="slider" id="whiteWarmRange" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> 3219K white
        <div style="display: inline; color:WhiteSmoke;">SMS1105UWDW 1750 0.44 0.44</div>
    </div>
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="white2MixtempRange" oninput="white2MixTempSilderChangeHandler(this)" onchange="white2MixTempSilderChangeHandler(this)">
        <div style='display: inline-block;' id="white2MixtempText">Temperature 4000</div>
    </div>
    <br>
    <br>
    <br>
    <div hidden class="slidecontainer" id="flashParameterContainer">
        <input type="range" min="1" max="255" value="10" class="slider" id="flashParameter1Range" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Flash On time
        <label id="flashOnTimeText">flashOnTimeText</label>
        <input type="range" min="1" max="255" value="10" class="slider" id="flashParameter2Range" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Flash Off time
        <label id="flashOffTimeText">flashOffTimeText</label>
    </div>
    <div hidden class="slidecontainer" id="pulseParameterContainer">
        <input type="range" min="1" max="255" value="10" class="slider" id="pulseParameter1Range" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Pulse In time
        <label id="pulseInTimeText">pulseInTimeText</label>
        <input type="range" min="1" max="255" value="10" class="slider" id="pulseParameter2Range" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Pulse Out time
        <label id="pulseOutTimeText">pulseOutTimeText</label>
    </div>
    <div hidden class="slidecontainer" id="orbitParameterContainer">
        <input type="range" min="0" max="255" value="128" class="slider" id="orbitParameter1Range" oninput="silderChangeHandler(this)" onchange="silderChangeHandler(this)"> Orbit Speed
        <label id="orbitSpeedText">orbitSpeedText</label>
    </div>
    <br>
    <br>
    <button onclick="writeButtonHandler()" type="button" id='writeButton'>Write value</button>
    <br>
    <br>
    <input type="checkbox" id="autoWrite" checked>Auto Write </body>
<br>
<br>
<button onclick="readButtonHandler()" type="button" id='readButton'>Read back value</button>
<br>

</html>