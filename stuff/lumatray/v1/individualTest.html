<!DOCTYPE HTML>
<html>

<head>
    <title>webBluetooth for individual test</title>
    <script>
        //generate template on https://beaufortfrancois.github.io/sandbox/web-bluetooth/generator/

        class LumaTrayBLEDevice {

            constructor() {
                this.device = null;
                this.onDisconnected = this.onDisconnected.bind(this);
                this.ledSending = false;
                this.individualQueue = [];
            }

            async request() {
                let options = {
                    "filters": [{
                        "services": ['4acdc426-31b0-4540-b15c-5803d278b32e']
                    }]
                };

                var device = await navigator.bluetooth.requestDevice(options)
                this.device = device;
                this.device.addEventListener('gattserverdisconnected', this.onDisconnected);

                return device;
            }

            connect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.connect();
            }

            async findLedCharacteristic() {
                var service = await this.device.gatt.getPrimaryService('4acdc426-31b0-4540-b15c-5803d278b32e');
                this.ledCharacteristic = await service.getCharacteristic('2a69d1fe-a0a2-4a7f-a6db-a180ec269730');
                this.individualCharacteristic = await service.getCharacteristic('9f129e42-605c-11eb-ae93-0242ac130002');
            }

            async writeLedService(data) {
                await this.ledCharacteristic.writeValue(data);
            }

            async writeIndividualService(data) {
                await this.individualCharacteristic.writeValue(data);
            }


            disconnect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.disconnect();
            }

            onDisconnected() {
                console.log('Device is disconnected.');
            }
        }

        var lumaTrayBLEDevice = new LumaTrayBLEDevice();

        document.addEventListener("DOMContentLoaded", function (event) {

        });

        async function connectButtonHandler(event) {
            try {
                await lumaTrayBLEDevice.request();
                await lumaTrayBLEDevice.connect();
                await lumaTrayBLEDevice.findLedCharacteristic();
                //Do something with testBLEDevice...
            } catch (e) {
                console.error(e);
            }
        }

        async function writeData(Arrdata) {
            var buffer = new Uint8Array(Arrdata).buffer;
            var data = new DataView(buffer);
            lumaTrayBLEDevice.individualQueue.push(data);

            if (!lumaTrayBLEDevice.ledSending) {
                lumaTrayBLEDevice.ledSending = true;
                try {
                    while(lumaTrayBLEDevice.individualQueue.length>0){
                        lastElement = lumaTrayBLEDevice.individualQueue.pop();
                        lumaTrayBLEDevice.individualQueue.length=0;
                        await lumaTrayBLEDevice.writeIndividualService(lastElement);
                    }
                } catch (e) {
                    console.error(e);
                }
                lumaTrayBLEDevice.ledSending = false;
            }else{
            }

        }





        function S126silderChangeHandler(sliderObj) {
            var redVal = parseInt(document.getElementById('S126redRange').value);
            var greenVal = parseInt(document.getElementById('S126greenRange').value);
            var blueVal = parseInt(document.getElementById('S126blueRange').value);
            document.getElementById('S126redText').innerHTML = 'Red ' + redVal;
            document.getElementById('S126greenText').innerHTML = 'Green ' + greenVal;
            document.getElementById('S126blueText').innerHTML = 'Blue ' + blueVal;
            writeData([0, redVal, greenVal, blueVal, redVal, greenVal, blueVal, redVal, greenVal, blueVal]);
            /*if (sliderObj.id == "modeRange") {
                modeSilderChangeHandler(sliderObj.value);
            }
            if (document.getElementById('autoWrite').checked) {
                writeButtonHandler();
            }*/
        }
        function M173200silderChangeHandler(sliderObj) {
            var redVal = parseInt(document.getElementById('M173200redRange').value);
            var greenVal = parseInt(document.getElementById('M173200greenRange').value);
            var blueVal = parseInt(document.getElementById('M173200blueRange').value);
            document.getElementById('M173200redText').innerHTML = 'Red ' + redVal;
            document.getElementById('M173200greenText').innerHTML = 'Green ' + greenVal;
            document.getElementById('M173200blueText').innerHTML = 'Blue ' + blueVal;
            writeData([9, redVal, greenVal, blueVal, redVal, greenVal, blueVal, redVal, greenVal, blueVal]);
        }
        function MHS110silderChangeHandler(sliderObj) {
            var redVal = parseInt(document.getElementById('MHS110redRange').value);
            var greenVal = parseInt(document.getElementById('MHS110greenRange').value);
            var blueVal = parseInt(document.getElementById('MHS110blueRange').value);
            document.getElementById('MHS110redText').innerHTML = 'Red ' + redVal;
            document.getElementById('MHS110greenText').innerHTML = 'Green ' + greenVal;
            document.getElementById('MHS110blueText').innerHTML = 'Blue ' + blueVal;
            writeData([18, redVal, greenVal, blueVal]);
        }
        function SMS1105silderChangeHandler(sliderObj) {
            var warmVal = parseInt(document.getElementById('SMS1105warmRange').value);
            var neutralVal = parseInt(document.getElementById('SMS1105neutralRange').value);
            var coolVal = parseInt(document.getElementById('SMS1105coolRange').value);
            document.getElementById('SMS1105warmText').innerHTML = 'Warm ' + warmVal;
            document.getElementById('SMS1105neutralText').innerHTML = 'Neutral ' + neutralVal;
            document.getElementById('SMS1105coolText').innerHTML = 'Cool ' + coolVal;
            writeData([21, neutralVal,0,0, coolVal,0,0, coolVal,0,0, warmVal,0,0, warmVal,0,0, neutralVal,0,0]);
        }


    </script>

</head>

<body>
    <button onclick="connectButtonHandler()" type="button" id='connectButton'>Connect</button>
    <br>
    <br>
    <br> IN-S126TASRGB
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="S126redRange" oninput="S126silderChangeHandler(this)" onchange="S126silderChangeHandler(this)">
        <div style='display: inline-block;' id="S126redText">Red 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="S126greenRange" oninput="S126silderChangeHandler(this)" onchange="S126silderChangeHandler(this)">
        <div style='display: inline-block;' id="S126greenText">Green 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="S126blueRange" oninput="S126silderChangeHandler(this)" onchange="S126silderChangeHandler(this)">
        <div style='display: inline-block;' id="S126blueText">Blue 0</div>
    </div>
    <br>
    <br>
    <br> 155124M173200
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="M173200redRange" oninput="M173200silderChangeHandler(this)" onchange="M173200silderChangeHandler(this)">
        <div style='display: inline-block;' id="M173200redText">Red 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="M173200greenRange" oninput="M173200silderChangeHandler(this)" onchange="M173200silderChangeHandler(this)">
        <div style='display: inline-block;' id="M173200greenText">Green 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="M173200blueRange" oninput="M173200silderChangeHandler(this)" onchange="M173200silderChangeHandler(this)">
        <div style='display: inline-block;' id="M173200blueText">Blue 0</div>
    </div>
    <br>
    <br>
    <br> MHS110CRGBCT (old one)
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="MHS110redRange" oninput="MHS110silderChangeHandler(this)" onchange="MHS110silderChangeHandler(this)">
        <div style='display: inline-block;' id="MHS110redText">Red 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="MHS110greenRange" oninput="MHS110silderChangeHandler(this)" onchange="MHS110silderChangeHandler(this)">
        <div style='display: inline-block;' id="MHS110greenText">Green 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="MHS110blueRange" oninput="MHS110silderChangeHandler(this)" onchange="MHS110silderChangeHandler(this)">
        <div style='display: inline-block;' id="MHS110blueText">Blue 0</div>
    </div>
        <br>
    <br>
    <br> SMS1105UWD 
    <br>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="SMS1105warmRange" oninput="SMS1105silderChangeHandler(this)" onchange="SMS1105silderChangeHandler(this)">
        <div style='display: inline-block;' id="SMS1105warmText">Warm 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="SMS1105neutralRange" oninput="SMS1105silderChangeHandler(this)" onchange="SMS1105silderChangeHandler(this)">
        <div style='display: inline-block;' id="SMS1105neutralText">Neutral 0</div>
    </div>
    <div class="slidecontainer">
        <input type="range" min="0" max="255" value="0" class="slider" id="SMS1105coolRange" oninput="SMS1105silderChangeHandler(this)" onchange="SMS1105silderChangeHandler(this)">
        <div style='display: inline-block;' id="SMS1105coolText">Cool 0</div>
    </div>
    
    
    


</body>

</html>